<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sepolia Price Feeds</title>

<!-- Ethers.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<style>
body {
  background: #0f172a;
  color: white;
  font-family: Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding-top: 40px;
  margin: 0;
}
.container {
  background: #020617;
  padding: 30px;
  border-radius: 14px;
  width: 500px;
}
button, select {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
}
button { background: #38bdf8; color: #020617; }
select { background: white; color: #020617; }
#status {
  margin-top: 12px;
  white-space: pre-line;
  font-weight: bold;
  color: #38bdf8;
}
#priceDisplay, #roundData {
  margin-top: 15px;
  padding: 10px;
  background: #1f2937;
  border-radius: 10px;
  font-family: monospace;
}
</style>
</head>

<body>
<div class="container">
  <h2>üîó Sepolia Chainlink Price Feeds</h2>

  <button id="connectBtn">Connect MetaMask</button>
  <div id="status">Not connected</div>

  <select id="feedSelect">
    <option value="">Select feed</option>
  </select>

  <button id="getPriceBtn">Get Latest Price</button>
  <div id="priceDisplay"></div>

  <button id="getRoundBtn">Get Full Round Data</button>
  <div id="roundData"></div>
</div>

<script>
let provider, signer, contract;
const CONTRACT_ADDRESS = "0x225d2dF3Cfb2Ef36fEa7790054D04aA4413Ea0Fe";

// ABI (only functions we need)
const ABI = [
  "function feedCount() view returns (uint256)",
  "function getFeedInfo(uint256 index) view returns (string memory name, address aggregator)",
  "function getLatestPrice(uint256 index) view returns (int256)",
  "function getLatestRoundData(uint256 index) view returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound)"
];

const statusEl = document.getElementById("status");
const feedSelect = document.getElementById("feedSelect");
const priceDisplay = document.getElementById("priceDisplay");
const roundData = document.getElementById("roundData");

// üîπ Connect wallet
document.getElementById("connectBtn").onclick = async () => {
  if (!window.ethereum) {
    const link = "https://metamask.app.link/dapp/" + window.location.host + window.location.pathname;
    window.location.href = link;
    return;
  }

  try {
    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();

    const network = await provider.getNetwork();
    if (network.chainId !== 11155111) {
      statusEl.innerText = "‚ùå Wrong network. Please switch to Sepolia.";
      return;
    }

    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    statusEl.innerText = "‚úÖ Connected\n" + accounts[0].slice(0,6) + "..." + accounts[0].slice(-4);

    await loadFeeds(); // populate dropdown
  } catch (err) {
    console.error(err);
    statusEl.innerText = "‚ùå Connection failed\n" + (err.message || "Unknown error");
  }
};

// üîπ Load feeds into dropdown
async function loadFeeds() {
  const count = await contract.feedCount();
  feedSelect.innerHTML = "<option value=''>Select feed</option>";
  for (let i = 0; i < count; i++) {
    const info = await contract.getFeedInfo(i);
    feedSelect.innerHTML += `<option value="${i}">${info[0]}</option>`;
  }
}

// üîπ Get latest price
document.getElementById("getPriceBtn").onclick = async () => {
  if (!contract) { alert("Connect wallet first"); return; }
  const index = feedSelect.value;
  if (index === "") { alert("Select a feed"); return; }

  try {
    const price = await contract.getLatestPrice(index);
    priceDisplay.innerText = "Latest Price: " + (price/1e8).toString();
  } catch (err) {
    console.error(err);
    priceDisplay.innerText = "Error: " + (err.message || err);
  }
};

// üîπ Get full round data
document.getElementById("getRoundBtn").onclick = async () => {
  if (!contract) { alert("Connect wallet first"); return; }
  const index = feedSelect.value;
  if (index === "") { alert("Select a feed"); return; }

  try {
    const data = await contract.getLatestRoundData(index);
    roundData.innerText = 
      `Round ID: ${data.roundId}\n` +
      `Answer: ${data.answer / 1e8}\n` +
      `Started At: ${new Date(data.startedAt*1000).toLocaleString()}\n` +
      `Updated At: ${new Date(data.updatedAt*1000).toLocaleString()}\n` +
      `Answered In Round: ${data.answeredInRound}`;
  } catch (err) {
    console.error(err);
    roundData.innerText = "Error: " + (err.message || err);
  }
};
</script>
</body>
</html>
